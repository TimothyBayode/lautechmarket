rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== HELPER FUNCTIONS =====
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the admin
    function isAdmin() {
      return isAuthenticated() && 
        request.auth.token.email.lower() in [
          "lautechmarket.help@gmail.com"
        ];
    }
    
    // Check if user is the vendor who owns the resource
    function isVendor(vendorId) {
      return isAuthenticated() && request.auth.uid == vendorId;
    }
    
    // ===== PRODUCTS =====
    match /products/{productId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.vendorId == request.auth.uid &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.price >= 0;
      allow update: if isAdmin() || (isVendor(resource.data.vendorId) && 
        request.resource.data.vendorId == resource.data.vendorId) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['orderCount', 'viewCount', 'cartCount', 'compareCount']));
      allow delete: if isAdmin() || isVendor(resource.data.vendorId);
    }
    
    // ===== VENDORS =====
    match /vendors/{vendorId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.auth.uid == vendorId;
      allow update: if isAdmin() || (isVendor(vendorId) && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isVerified'])));
      allow delete: if isAdmin();
    }
    
    // ===== CATEGORIES =====
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ===== ANNOUNCEMENTS =====
    match /announcements/{announcementId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ===== VERIFICATION REQUESTS =====
    match /verificationRequests/{requestId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.vendorId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.vendorId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // ===== ANALYTICS =====
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow write: if true;
    }
    
    match /analytics_events/{docId} {
      allow read: if isAdmin();
      allow write: if true;
    }
    
    // ===== VENDOR VISITS =====
    match /vendorVisits/{vendorId} {
      allow read: if isAdmin() || isVendor(vendorId);
      allow write: if true;
      
      match /ips/{ipHash} {
        allow read: if isAdmin() || isVendor(vendorId);
        allow write: if true;
      }
    }
    
    // ===== VISIT HISTORY =====
    match /visitHistory/{periodId} {
      allow read: if isAuthenticated(); // Allow vendors to see past rankings
      allow write: if isAdmin();
    }

    // ===== SEARCHES =====
    match /searches/{searchId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // ===== BUCKETS =====
    match /buckets/{bucketId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ===== CURATION =====
    match /curatedLists/{listId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ===== VENDOR CONTACTS =====
    match /vendorContacts/{contactId} {
      allow create, read: if true;
      allow update: if isAdmin();
    }

    // ===== VENDOR METRICS =====
    match /vendorMetrics/{vendorId} {
      allow read: if true;
      allow write: if true; // Required for student feedback triggers to update trust scores
    }
  }
}
